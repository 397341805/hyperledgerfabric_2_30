# 区块链网络

​	这个话题会在概念层面上描述 Hyperledger Fabric 是如何让组织间以区块链网络的形式进行合作的。如果你是一个架构师，管理员或者开发者，你可以通过这个话题来理解在 Hyperledger Fabric 区块链网络中的主要结构和处理组件。本主题将使用一个可管理的运作示例，介绍区块链网络中的所有主要组件。

​	当阅读完这个话题并且理解策略的概念后，你就能够完全理解组织为控制一个已部署的Hyperledger Fabric网络而建立策略时需要做出的决定。你还将了解组织如何使用声明的策略管理网络的演变，这是fabric的一个重要特点。

​	简言之，你会理解 Hyperledger Fabric 的主要技术组件以及组织对于它们所要做的决策。

​	注意：这个主题描述的网络使用了“系统通道”，该通道由排序服务引导启动，并由排序服务独占控制，它在图中被表示为网络配置NC4。自从v2.3发布以来，与创建没有系统通道的通道相比，使用系统通道现在被认为是传统的处理方式。

## 什么是区块链网络

​	区块链网络是一个为应用程序提供账本及智能合约（chaincode）服务的技术基础设施。首先，智能合约会产生交易，接下来这些交易会被分发给网络中的每个节点，这些交易会被记录在他们的账本副本上并且它们是不可篡改的。

​	在大多数的情况下，多个组织会聚集到一起作为一个联盟来形成一个网络，并且他们的权限是由一套在网络最初配置的时候联盟成员都同意的规则来决定的。并且，网络的规则可以在联盟中的组织同意的情况下随时地被改变，就像当我们讨论修改规则概念中说的那样。

## 示例网络

​	在我们开始前，让我们来展示一下我们最终要做的东西吧！下方的图表展示了我们的示例网络的最终状态。

​	不必担心这个看起来非常复杂！在我们学习这个话题的过程中，我们会一点一点地构建起这个网络，所以你能够了解组织R1、R2、R3 和R4是如何帮助网络构建基础设施。这个基础设施实现了区块链网络，并且它是由来自网络中的组织都同意的规则来管理的，比如谁可以添加新的组织。你会知道应用是如何使用区块链网络中账本和智能合约提供的服务。

![network.structure](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.1.png)

​	四个组织R1、R2、R3和R4，他们共同决定，并且达成了一个协议，他们将会建立并开发一个 Hyperledger Fabric 网络。R4被分配作为网络的发起人，它有权设置网络的初始版本。R4 不会在网络中去进行任何的业务交易。R1 和 R2 在整个网络中有进行私有通信的需求，R2和R3 也是。R1 有一个客户端的应用能够在通道C1中进行商业交易，R2 有一个客户端应用可以在通道C1和C2中进行类似的工作，R3可以在通道C2中做这样的工作。对等节点P1维护了C1的账本L1的副本。对等节点P2维护了C1的账本L1和C2的账本L2的副本。对等节点P3维护了C2的账本L2的副本。这个网络是根据在网络配置NC4中指定的规则来进行管理的，整个网络由组织R1和R4管理。通道C1是根据在通道配置CC1中指定的规则来管理的，这个通道由组织R1和R2管理。通道C2是根据在通道配置CC2中指定的规则来管理的，这个通道由组织R2和R3管理。排序节点O4是这个网络N的一个网络管理员节点，并且它使用系统通道。排序服务同时也支持应用通道C1和C2，来对交易进行排序、加入区块然后分发。每个组织都有一个首选的CA。

## 创建网络

​	让我们从头开始来创建网络的基础：当一个排序节点启动后就形成了这样的一个网络。在我们的示例网络N中，排序节点O4由一个单独的节点组成，是根据一个网络配置NC4来进行配置的。在网络层面上，证书颁发机构CA4被用来向管理员和组织R4的网络节点分配身份信息。

​	我们可以看到，在定义网络N的时候，第一件事情就是定义一个排序节点，O4。将排序节点设置为网络的初始管理节点是有帮助的。正如事先约定的，O4最初被配置并且由组织R4的一个管理员来启动，并且由R4管理。配置NC4中的策略描述了网络管理功能的初始集。最初在网络中仅赋予了R4这个权利。这在将来会发生变化，我们稍后会看到，但是目前R4是这个网络中唯一的一个成员。											![network.creation](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.2.png)

## 证书颁发机构（Certificate Authorities，CA）

​	在图中你也可以看到一个证书颁发机构，CA4，它被用来给管理者和网络节点颁发证书。CA4在我们的网络中扮演着重要的角色，因为它会分配X.509证书，这个证书能够用来识别属于组织R4的组件。由CA颁发的证书也可以用来为交易提供签名，来表明一个组织对交易的结果进行背书，背书是一笔交易可以被接受并记录到账本上的前提条件。让我们对CA的两个方面进行更详细的介绍。

​	首先，在区块链网络中的不同组件之间，彼此是使用证书来标识自己是来自于特定组织的。这就是为什么通常会有多个CA来支持一个区块链网络，因为不同的组织通常会使用不同的CA。在我们的网络中，我们会使用4个CA，每个组织会有一个CA。事实上，CA是非常重要的，所以HyperledgerFabric提供给你一个内置的CA（被称为Fabric-CA）以方便使用，尽管在实际当中，组织会选择使用它们自己的CA。

​	将证书同成员组织进行匹配是通过一个称为成员关系服务提供者（Membership Service Provider, MSP）的结构来实现的。网络配置NC4使用一个已命名的MSP来识别由CA4颁发的证书的属性，这些证书会关联到组织R4下的证书持有者。然后，NC4可以根据策略识别这个MSP的名称从而授予来自R4的参与者对网络资源的特定权限。这个策略的一个例子就是，识别R4中管理员的身份，然后给管理员向网络中添加新的成员组织的权限。我们没有设置图标显示MSP，因为他们会很杂乱，但是他们是非常重要的。

​	第二点，接下来我们会看到为何由 CA 签发的证书在交易的生成和验证的流程中处于核心位置。X.509 证书被用于客户端应用的交易提案和智能合约的交易响应，来对交易进行数字签名。接下来持有账本副本的网络节点会验证交易签名是否有效，从而决定是否接受将交易更新到账本。

​	让我们重新整理一下我们的区块链网络示例的基本结构，其中有一个源R4，网络N，有一些用户能够访问这个网络，这些用户是由一个证书颁发机构CA4定义的，他们具有网络配置NC4中包含的规则中所描述的在网络N中的权利。上述这些会在我们配置和启动排序节点O4的时候产生。

## 添加网络管理员

​	NC4最初被配置为只允许R4用户在网络上拥有管理权限。在下一个阶段中，我们将允许组织R1的用户管理网络。让我们看看网络是如何演变的:

![network.admins](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.2.1.png)

​	组织R4更新了网络配置来使组织R1也成为了管理员。现在R1和R4在网络配置中便具有了相同的权限。

​	我们可以看到了新加进来的组织R1变成了管理员，R1和R4现在在网络中具有了相同的权限。我们看到证书颁发机构CA1也被添加进来了，他用来标识R1组织的用户。现在从R1和R4来的用户就已经是网络的管理员了。

​	尽管排序节点O4是运行在R4的基础设施上的，但是现在R1也能够对网络进行访问了，从而可以共享管理员权限。也就是说R1或者R4都可以更新这个网络配置NC4来允许新的组织R2进行网络部分功能的运作。通过这种方式，尽管R4运行着排序服务，但是R1在其中也具有着全部的管理员权限，而R2也具有有限的创建新联盟的权限。

​	在这个最简单的模式中，排序服务在网络中是一个独立的节点，就像你在例子中看到的。排序服务通常是多节点的，也可以被配置为在不同组织中的不同节点上。比如，我们可能会在R4中运行O4并连接到O2，O2是在组织R1中的另一个排序节点。通过这种方式，我们就有了一个多节点、多组织的管理结构。

​	我们会在后边讨论更多关于排序服务的话题，但是目前只需要把排序服务当成是一个管理者，它给不同的组织提供了对于网络的管理的权限。

## 定义联盟

​	尽管这个网络当前可以被 R1 和 R4 管理，但是只有这些还是太少了。我们需要做的第一件事就是定义一个联盟。这个词表示“具有着共同命运的一个群组”，也就是在一个区块链网络中合理地选择出来的一些组织。

​	让我们来看看如何定义一个联盟：										![network.consortium](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.3.png)

​	网络管理员定义了一个包含两个成员的联盟X1，包含组织R1和R2。这个联盟的定义被存储在了网络配置NC4中，它会在接下来的网络开发中被使用。CA1和CA2是这两个组织对应的证书颁发机构。

​	由于NC4的配置方式，只有R1和R4能够创建新的联盟。图中有一个新的联盟X1，它定义了R1和R2是它的联盟组织。我们也看到了CA2也被添加进来标识来自R2的用户。注意一个联盟可以包含任意数量的组织，这里我们展示的是一个仅包含两个组织的最简单的配置。

​	为什么联盟这么重要？我们能够看到联盟定义了网络中的一部分组织，它们都有与彼此进行交易的需求，在这个示例中就是R1和R2能够进行交易。联盟对于这样一组有着共同的目的的组织来说是有意义的。

​	这个网络虽然最初仅包含一个组织，现在已经由多个组织来管理了。我们将从R1、R2和R4共享管控权的方式开始，这样的构成更容易被理解。

​	现在我们要使用联盟X1创建一个对于HyperledgerFabric区块链非常重要的部分——通道。

## 为联盟创建通道

​	现在让我们来创建对于 Fabric 区块链网络的关键部分——通道。通道是一个联盟中的成员彼此进行通信的主要机制。在一个网络中可能会有多个通道，现在让我们先从一个通道开始。

​	让我们来看下第一个通道是如何被添加到这个网络中的：

![network.channel](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.4.png)

​	使用联盟X1为R1和R2创建通道C1。这个通道通过通道配置CC1来进行管理，完全独立于网络配置。CC1是由R1和R2管理的，他们在C1上具有同等的权利。R4在CC1中是没有任何权利的。

​	通道C1为联盟X1提供了一个私有的通信机制。我们能够看到通道C1已经关联到了排序服务O4但是并没有附带任何功能。在网络开发的下一个阶段，我们将会连接不同的组件，比如客户端应用和对等节点。但是到目前为止，一个通道只代表将来要进行连接的可能性。

​	尽管C1是网络N中的一部分，它还是跟这个网络非常不同的。同时也要注意到组织R3和R4并没有在这个通道中，因为这个通道仅仅是为了处理在R1和R2之间进行的交易。在上一步中，我们看到了R4是如何为R1分配权限来创建新的联盟，R4同样也允许R1来创建通道。在这个图中，创建C1的组织可以是R1或者R4。再次强调，一个通道可以包含任意数量的组织，但是我们目前只包含了两个组织，这是一个最简单的配置。

​	需要注意的是通道C1如何具有一个同网络配置NC4完全分开的配置CC1。CC1上包含的策略赋予了R1和R2在通道C1上的权限，就像我们看到的那样，R3和R4在这个通道中没有权限。R3和R4只有被R1或R2添加到通道配置CC1中的策略后才能够用C1进行交互。例如，在定义谁能向通道中添加新组织时，要注意到R4不能将它自己添加到通道C1中的，这个只能由R1或者R2来授权添加。

​	为什么通道会如此重要？通道非常有用，因为它为联盟成员之间进行的私有通信和私有数据提供了一个机制。通道能够保证隐私不被泄露到别的通道或者整个网络。Hyperledger Fabric 在这一点上是很强悍的，因为它允许组织间共享基础设施的同时又保持了私有性。这里并不矛盾，网络中不同的联盟之间会需要将不同的信息和流程进行合适的共享，通道为之提供了有效的机制。通道在提供有效的基础设施共享的同时也保持了数据和通信的隐私性。

​	我们也能够看到一旦通道被创建之后，它会真正地代表了“从网络中解放出来”。在创建之后，只有在通道配置中指定的组织才能够控制它。同样的，在此之后的对于网络配置 NC4 的任何改动都不会对通道配置 CC1 造成任何直接的影响。比如如果联盟定义 X1 被改动了，它不会影响通道 C1 的成员。所以通道是很有用的，因为他们允许构成通道的组织间进行私密的沟通。并且在通道中的数据跟网络中的其他部分是完全隔离的，包括其他的通道。

​	同时，这里还有一个被排序服务使用的特殊的系统通道。它跟常规的通道是完全一样的方式运行的，因此常规的通道有时候又被称为应用通道。我们通常不会关心这个系统通道，但是以后我们会更详细的讨论它。

## 对等节点和账本

​	现在，让我们开始使用通道来将这个区块链网络以及其他构成组件关联到一起吧。在网络开发的下一个阶段，我们能够看到我们的网络N又新增了两个组件，称作对等节点P1和账本实例L1。

![network.peersledger](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.5.png)

​	一个Peer节点P1加入了通道C1。P1会在物理上存储账本L1的副本。P1和O4可以使用通道C1来进行通信。我们终于开始看到一些标志性的区块链组件了！P1在这个网络中的目的仅是持有一份供别人访问的L1的副本。我们可以想象L1会被物理地存储在P1上，但是逻辑上是存储在通道C1上。当我们向通道中添加更多的节点之后，对这些就会更加清楚。

​	P1的配置中一个关键部分就是一个由CA1颁发的X.509身份信息，它将P1和组织R1关联了起来。当R1的管理员要将P1加入C1并且对等节点要开始从排序节点O4拉取区块时，排序节点会使用通道配置CC1来决定P1在该通道上的权限。例如，CC1上的策略决定了P1能否在通道C1上进行读写。

​	注意对等节点是如何通过所在组织加入通道，尽管我们仅仅加了一个节点，我们将会看到如何在网络中将多个节点加入多个通道。我们也会在后边的部分看到节点能够扮演的不同的角色。

## 应用程序与智能合约链码

​	现在通道 C1 拥有了一个账本，我们可以连接客户端应用来使用由 Peer 节点提供的服务了。

​	注意网络是如何变化的：

![network.appsmartcontract](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.6.png)

​	智能合约S5被安装在了P1上。在组织R1中的客户端应用A1可以通过P1使用S5来访问账本。A1、P1和O4都加入了通道C1，他们都可以使用由这个通道提供的通信设施。	

​	在网络开发的下一个阶段，我们可以看到客户端应用A1能够使用通道C1来连接指定的网络资源，在这个示例中，A1能够连接对等节点P1和排序节点O4。再次注意，看看通道是如何在网络和组织的组件的通信中发挥中心作用的。就像对等节点和排序节点一样，客户端应用也会有一个使它和组织相关联的身份信息。在我们的例子中，客户端应用A1是跟组织R1相关联的，尽管它处在Fabric区块链网络的外边，但它是可以通过通道C1跟网络相连的。

​	现在我们能够清楚地看到A1能够通过P1直接访问账本L1，但是事实上，所有的访问都是由智能合约链码S5这个特殊程序来管理的。可以将S5看作是定义了对账本的常规访问模式。S5提供了一套定义明确的方法，通过这些方法可以查询或更新账本L1。

​	每个组织的应用开发者都可以创建智能合约来实现在联盟成员间共享的业务流程。智能合约被用来帮助生成被分发到网络中每个节点的交易，我们接下来会详细讨论，当网络规模更大了之后，这个会更容易理解。现在要理解的更为重要的事情是，为了使用智能合约需要执行两项操作，在对等节点上安装智能合约，然后在通道中定义。

​	Hyperledger Fabric用户经常会在内部使用名词智能合约和链码。大体上来说，智能合约定义了交易逻辑，它控制着在世界状态中的一个业务对象的生命周期。然后它会被打包进链码，这个链码会被部署到区块链网络中。可以把智能合约想象为在管理交易，链码则管理着智能合约应该如何被打包部署。

### 安装链码包

​	在智能合约S5开发完成之后，组织R1中的管理员必须要把它安装到节点P1上。这是一个很简单的操作。当完成之后，P1就完全了解了S5。特别地，P1能够看到S5的实现逻辑（用来访问账本L1的程序代码），这个同S5的接口的区别是，接口只是描述了S5的输入和输出，但是没有它的实现。

​	当一个组织在一个通道中有多个Peer节点时，可以选择在哪个节点安装智能合约，而不需要每个Peer节点上都安装。

### 定义链码

​	尽管链码是被安装在组织的对等节点上，但是它是在一个通道范围内被管理和运作的。每个组织需要对链码定义，和一系列参数进行批准来确定在一个通道中链码应该被如何使用。一个组织必须要批准一个链码定义，才能使用已经安装的智能合约来查询账本和为交易背书。在我们的例子中，只有一个单独的对等节点P1和组织R1中的管理员，它们要对S5的链码定义进行批准。

​	在将链码定义提交到通道并用于与通道帐本交互之前，需要有足够数量的组织批准链码定义(默认情况下是大多数)。因为通道中只有一个成员，R1的管理员可以提交S5的链码定义到通道C1。当这个定义提交后，S5就可以被客户端应用A1调用了！

​	注意，虽然在这个通道上的每个组件现在都可以访问S5，但是他们是不能够看到它的程序逻辑的。即使对于安装了这个智能合约的节点，智能合约还是会保持隐私性，例如在我们的例子中的P1。从概念上讲，这意味着实际上只是定义并提交了智能合约的接口到通道，而不是安装了智能合约的具体实现代码。为了强调这个想法，安装智能合约展示了我们是如何将它物理地存储在对等节点上，而在通道上定义智能合约展示了我们是如何将它逻辑地存储在通道中。

### 背书策略

​	在链码定义提供的信息中最重要的部分就是背书策略。它描述了在交易被其他的组织接受并存储在他们的账本副本上之前，哪些组织必须要同意此交易。在我们的示例网络中，只有当R1和R2对交易进行背书之后，交易才能够被接受并存储到账本L1中。

​	将链码定义提交到通道的同时背书策略也会被放置在通道账本上，通道中的每个成员都可以访问该策略。你可以在交易流程话题中阅读更多关于背书策略的内容。

### 调用智能合约

​	当智能合约被安装在对等节点并且在通道上定义之后，它就可以被客户端应用调用了。客户端应用是通过发送交易提案给智能合约背书策略所指定的对等的节点方式来调用智能合约的。这个交易的提案会作为智能合约的输入，智能合约会使用它来生成一个背书交易响应，这会由对等节点返回给客户端应用。

​	这些交易的响应会和交易的提案打包到一起形成一个完整的经过背书的交易，他们会被分发到整个网络。我们会在之后更详细的了解，现在理解应用是如何调用智能合约来生成经过背书的交易就已经足够了。

​	在网络发展的这一阶段，我们可以看到组织R1完全参与到网络中。从网络的应用A1提交请求开始，然后通过智能合约S5访问账本L1，并生成将要被R1背书的交易，最后交易会被接受并添加到账本中，因为这符合背书策略。

## 完成网络

​	我们的目标是为联盟 X1（由组织 R1 和 R2 构成）创建一个通道。网络开发的下一个阶段是将组织 R2 的基础设施添加到网络中。

​	让我们看一下网络是如何演进的：

![network.grow](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.7.png)

​	网络增加新组织R2的基础设施之后规模扩大了。具体来说，R2添加了Peer节点P2，它会存有账本L1的一个副本，和链码S5。R2像R1一样批准了相同的链码定义。P2也加入了通道C1，也有一个客户端应用A2。A2和P2使用由CA2颁发的证书来标识自己。上述这些说明了A1和A2都能够通过对等节点P1或者P2来调用在C1上的S5。

​	我们能够看到组织R2在通道C1上添加了对等节点P2。P2也存储了账本L1和智能合约S5的副本。R2也添加了客户端应用A2，它能够通过通道C1连接到网络。为了达到这个目的，组织R2的管理员添加了对等节点P2并且将它加入到通道C1，就像R1的管理员一样。R2管理员也必须要像R1那样批准相同的链码定义。

​	这样就创建了我们的第一个可运行的网络！目前，我们定义了一个通道，在这个通道中组织 R1 和 R2 能够彼此进行交易。特别地，这意味着 A1 和 A2 能够使用在通道 C1 上的智能合约 S5 和账本 L1 来产生交易。

### 生成并接受交易

​	相较于经常会存有账本副本的对等节点，我们能够看到两种类型的对等节点，一类存储了智能合约而另一类则不存储。在我们的网络中，每个对等节点都会存储智能合约的副本，但是在一个更大的网络中，会存在更多的对等节点并且没有存储智能合约的副本。节点只有在安装了智能合约之后才能够运行它，但是这个对等节点可以通过连接到通道来获取一个智能合约的接口信息。

​	对于没有安装智能合约的对等节点，我们不应该认为他们在某种程度上是较差的。更多情况下，带有智能合约的对等节点通常会拥有一个特殊的能力——帮助生成交易。需要注意的是所有的对等节点都可以验证并接受或者拒绝交易存入他们的账本L1的副本中。然而，只有安装了智能合约的对等节点才能够参与交易背书的流程，这是生成一笔有效交易的核心。

​	在这个部分中我们不需要关心交易是如何生成、分发和被接受这些细节，只需知道我们有一个区块链网络，在这个网络中组织R1和R2能够共享由账本记录的交易信息和流程就够了。我们会在其他的部分学习更多关于交易、账本以及智能合约。

### 对等节点的类型

​	在Hyperledger Fabric中，所有的对等节点都是一样的，基于这个网络的配置，对等节点能够担当多个角色。我们现在对于描述这些角色的典型网络拓扑已经有足够的理解了。

- 提交节点（Committing peer.）。通道中的每个对等节点都是一个提交节点。他们会接收生成的区块，在这些区块被验证之后会以附加的方式提交到对等节点的账本副本中。
- 背书节点（Endorsing peer）。每个安装了智能合约的对等节点都可以作为一个背书节点。然而，想要成为一个真正的背书节点，节点上的智能合约必须要被客户端应用使用，来生成一个被签名的交易响应。背书节点的术语就是这样来的。

上面的是对等节点的两个主要类型。一个对等节点还可以担任的两种其他的角色：

- 主节点（Leader peer）。当组织在通道中具有多个对等节点的时候，会有一个主节点，它负责将交易从排序节点分发到该组织中其他的提交节点。一个节点可以选择参与静态或者动态的主节点选举。

  这是很有用的，从管理者的角度来考虑的话会有两套节点，一套是静态选择的主节点，另一套是动态选举的主节点。对于静态选择，0个或者多个节点可以被配置为主节点。对于动态选举，一个节点会被选举成为主节点。另外，在动态选举主节点中，如果一个主节点出错了，那么剩下的节点将会重新选举一个主节点。

  这意味着一个组织的节点可以有一个或者多个主节点连接到排序服务。这有助于改进需要处理大量交易的大型网络的弹性以及可扩展性。

- 锚节点（Anchor peer）。如果一个对等节点需要同另一个组织的对等节点通信的话，它可以使用对方组织通道配置中定义的锚节点。一个组织可以拥有0个或者多个锚节点，并且一个锚节点能够协助很多不同的跨组织间的通信。

  需要注意的是，一个对等节点可以同时是一个提交节点、背书节点、主节点和锚节点。在实际情况中只有锚节点是可选的，一般都会有一个主节点，至少一个背书节点和一个提交节点。

### 向通道中添加组织和节点

​	当R2加入到通道的时候，组织必须要向它的对等节点P2上安装智能合约S5。这很明显，如果应用A1或者A2想要使用对等节点P2上的S5来生成交易，节点P2就必须安装了智能合约S5。现在，对等节点P2有了智能合约和账本的物理的副本，像P1一样，它可以生成并接受交易记到它的账本L1的副本上了。

​	R2必须要像R1那样批准相同的链码定义才能够使用智能合约S5。因为链码定义已经被组织R1提交到了通道，当R2的组织批准了链码定义并且安装了链码包之后，R2就可以使用链码了。链码定义的提交事务只需要进行一次，通道中新的组织批准了通道中其他成员已经同意的链码参数之后就可以使用链码了。因为链码定义的批准是发生在组织级别的，所以R2只需要批准链码定义一次，然后就可以将多个节点加入到安装了链码包的通道。然而，如果R2想改变链码的定义，那么新的定义需要同时得到R1和R2的批准，然后其中的一个组织需要将定义提交到通道。

​	在我们的网络中，我们能够看到通道C1连接了两个客户端应用、两个对等节点和一个排序服务。因为这里只有一个通道，也就只有一个跟这个通道组件交互的逻辑账本。对等节点P1和P2具有相同的账本L1的副本。智能合约S5的副本通常会使用相同的编程语言来进行相同的实现，如果语言不同，他们也必须有相同的语义。

​	我们能够看到，在网络谨慎的增加对等节点有助于提升吞吐量、稳定性以及弹性。比如，若网络中有更多的节点将使得更多的应用来连接这个网络，这样当组织中有多个节点发生已知或未知的停机的时候可以缓解其带来的影响。

​	这意味着可以通过配置网络拓扑来支持不同的目的，网络的大小是没有理论上限的。并且，通过gossip协议，一种使得组织内节点发现彼此并进行通信的技术机制，可以容纳大量的对等节点来支持这样的网络拓扑。

​	对于网络和通道策略的谨慎使用可以很好的管理庞大的网络。组织可以随意地向网络中添加对等节点，只要他们满足了网络的策略。网络及通道的策略在自主和管控之间达成的平衡是去中心化网络的特征。

## 简化网络表示图

​	我们现在要简化一下我们的示例区块链网络的表示图。随着网络的增长，之前帮助我们理解通道的连线将会变得越发笨拙。设想一下如果我们添加了另外一个 Peer 节点或者客户端应用，又或者另外一个通道的话，我们的图表将会变得有多复杂。

​	我们接下来要为网络中添加更多内容，在我们做这个之前，让我们来一起简化一下网络表示图。下边是我们目前开发的网络的简图：

![network.vocabulary](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.8.png)

​	这个图展示了在网络N中和通道C1的相关内容：客户端应用A1和A2能够通过节点P1和P2以及排序节点O4使用通道C1来进行通信。对等节点P1和P2可以使用通道C1的通信服务。排序服务O4可以使用通道C1的通信服务。通道配置CC1应用于通道C1。

​	注意，这个网络的图表通过将通道连线替换成了连接点的方式进行了简化，连接点显示为一个蓝色的圆圈，里边包含了通道数字。没有任何的信息丢失。	这种表示方式的扩展性更强，因为它去除了交叉的连接线。这让我们能够更清晰地展现更大的网络。在这种简化方式中，我们更加关注组件和通道之间的连接点，而不是通道本身的方式。

## 添加另外一个联盟定义

​	在网络开发的下一个阶段，我们引入了组织 R3。我们将会给 R2 和 R3 一个新的独立的应用通道，以便他们互相进行交易。这个应用通道会同之前定义的通道完全分离开来，所以 R2 和 R3 的交易信息会对之前的通道保持良好的隐私性。

​	让我们在网络中为 R2 和 R3 定义一个新的联盟 X2：

​	![network.consortium2](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.9.png)

​	来自R1或者R4的网络管理员添加了一个新的联盟定义X2，其中包含了R2和R3。然后可以根据这个联盟定义来定义X2的一个新的通道。

​	注意到现在网络中已经定义了两个联盟：组织R1和R2的联盟X1，以及组织R2和R3的联盟X2。引入联盟X2是为了给R2和R3创建一个新的通道。

​	新通道只能够由网络配置策略NC4中指定的组织比如R1或者R4来创建，因为只有他们才有相关的权限。这是一个网络策略的例子，该策略能够将在网络级别管理资源的组织与能够在通道级别管理资源的组织分开。

​	实际上，联盟定义X2已经被添加进了网络配置NC4。我们会在文档的其他部分讨论具体的技术细节。

## 添加一个新的通道

​	让我们使用这个新的联盟定义 X2 来创建一个新的通道 C2。为了帮助加强你对于简化版通道符号的理解，我们会使用两种样式：通道 C1，使用蓝色的圆圈来表示；通道C2，使用红色的连接线表示：

![network.channel2](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.10.png)

​	新的通道X2是为R2和R3创建的，使用联盟定义X2。这个通道具有通道配置CC2，完全同网络配置NC4以及通道配置CC1分离。通道C2由R2和R3来管理，在CC2的策略中R2和R3具有相同的权利。R1和R4在CC2中是没有任何权利的。

​	通道 C2 为联盟 X2 提供了一个私有的通信机制。再次提醒，联盟中的组织进行联合的方式就是通道。通道配置 CC2 现在包含了管理通道资源的策略，它可以向组织R2和R3分配它们在C2上的管理权限。这由 R2 和 R3 唯一管理，R1 和 R4 在通道 C2 中是没有权力的。比如可以更新通道配置 CC2 来添加新的组织，但是这个只能由 R2 或者 R3 来完成。

​	注意，通道配置 CC1 和 CC2 以及网络配置 NC4 是彼此完全分离的。从这里我们能再次看到Hyperledger Fabric 网络的去中心化的特点。一旦通道 C2 被创建后，它是由组织 R2 和 R3 来管理的，独立于网络中的其他元素。各个通道的策略通常是保持彼此分离的，并且只能由通道中授权的组织来进行改动。

​	随着网络和通道的发展，网络和通道的配置也会升级。这里有一个以可控形式实现的流程——引入包含配置变更的配置交易。每次配置的改变会生成一个新的配置区块，在后边的话题中，我们会看到这些区块是如何被验证和接受，并更新相关网络及通道的配置。

### 网络和通道配置

​	在我们的示例网络中，我们看到了网络和通道配置的重要性。这些配置很重要，是因为他们封装了网络成员商定的**策略**，这个策略可以对网络资源访问控制提供指导。网络和通道配置也包含了有关网络和通道组成的一些**情况**，比如联盟的名字以及它所包含的组织。

​	比如，当使用排序服务节点O4首次组建网络的时候，它的行为是由网络配置NC4来管理的。NC4的初始配置中只包含了允许组织R4来管理网络资源的策略。NC4接下来被变更为也允许R1来管理网络资源。一旦这个改动生效后，任何来自于组织R1或者R4的管理员连接到O4都将具有网络管理的权限，因为这是网络配置NC4中的策略所允许的。在每个排序节点中都记录着网络配置中的每个通道，所以在网络中每个通道被创建时都会有一条记录。

​	这就意味着，虽然排序节点O4创建了联盟X1和X2以及通道C1和C2，但是O4遵守的网络策略是存储在网络配置NC4中。这就意味着，尽管排序节点O4创建了联盟X1和X2以及通道C1和C2，网络配置NC4中包含了O4遵守的这个网络的智慧。只要O4是一个好的参与者，并且在它处理网络资源的任何时候都能够遵守在NC4中定义的策略的话，那么我们的网络就会按照所有的组织一致同意的方式工作。在很多方面NC4被认为要比O4更重要，因为最终是它来管控网络的访问。

​	与对等节点同样的概念也可以适用于通道配置。在我们的网络中，P1和P2是很类似的角色。当对等节点P1和P2同客户端应用程序A1或者A2进行交互的时候，他们使用了在通道配置中定义的策略来管理对通道C1资源的访问。

​	比如，如果A1想要访问在对等节点P1或者P2上的智能合约链码S5的话，每个对等节点会使用它的CC1的副本来决定A1能够进行哪些操作。比如根据在CC1中定义的策略，A1可能被允许从账本L1上读取或者写入数据。后边我们会看到对于通道和通道配置CC2中的角色会有相同的模式。我们能够看到尽管对等节点和应用程序在网络中是关键的角色，但他们在一个通道中的行为更多的是由通道配置的策略来决定的。

​	最后，理解网络和通道配置是如何在物理上来实现的是非常重要的。我们能够看到网络和通道的配置在逻辑上是独立的，网络会有一个配置，每个通道也会有一个配置。这一点非常重要。任何访问网络或者通道的组件必须对不同组织被授予的权限达成共识。

​	尽管在逻辑上是独立的配置，实际上它会被复制到组成网络或者通道的每个节点，并保持一致。比如，在我们的网络中，节点P1和P2都有通道配置CC1的副本，在这个网络完成的时候，节点P2和P3也会有通道配置CC2的副本。类似的，排序节点O4有网络配置的副本，而在多节点配置中，每个排序节点都会有他们自己的关于网络配置的副本。

​	网络及通道的配置与用户交易一样，都是通过使用区块链技术来保证一致性，只是这种交易被叫做配置交易。想要改变网络或者通道的配置，管理员必须要提交一个配置交易来改变网络或者通道的配置。该交易必须被对应策略中指定的组织签名，这些组织负责配置的变更。这个策略被称为mod_policy我们稍后讨论。

​	实际上，排序节点运行着一个小型的区块链，它通过我们前边提到的系统通道连接。排序节点使用系统通道分发网络配置交易。这些交易被用来维护每个排序节点间网络配置副本的一致性。类似的，应用程序通道中的对等节点分发通道配置交易。同样，这些交易被用来维护每个对等节点通道配置的一致性。 

​	这种通过物理上的分发来实现逻辑上独立的对象间的均衡的模式在Hyperledger Fabric是很常见的。像网络配置这样的对象，逻辑上是独立的，但在一些排序服务节点间被物理复制。对于通道配置、账本及智能合约，我们也看到了这样的情况，它们被安装在了多个地方，但是在通道级别上只对它们的接口进行了逻辑存储。这种模式你会在 Hyperledger Fabric 中重复地看到多次，这使 Hyperledger Fabric 既是去中心化的，同时又是易于管理的。

## 添加另一个对等节点

​	现在组织 R3 能够完全地参与到通道 C2 中了，让我们来把它的基础设施组件添加到通道中。我们不会每次只加一个组件，我们将会一次性地将对等节点、它本地的账本副本、智能合约以及客户端应用程序都加进来。

​	让我们看一下添加了组织 R3 的组件的网络是什么样：

​			![network.peer2](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.11.png)

​	这个图展示了在网络N中关于通道C1和C2的以下内容：客户端应用程序A1和A2可以使用通道C1来同节点P1和P2，以及排序服务O4进行通信。客户端应用程序A3能够使用C2同节点P3和排序服务O4进行通信。排序服务O4可以使用通道C1和C2的通信服务。通道配置CC1应用到了通道C1上，CC2应用到了通道C2上。

​	首先，要注意的是因为对等节点P3连接到了通道C2，所以它有一个和使用通道C1的节点不同的账本L2。账本L2被有效地控制在了通道C2中。账本L1是完全独立的，它被限制在了通道C1。通道C2的目的是为联盟X2的成员提供私密通信，并且账本L2是他们的交易的私密存储，这么做是有意义的。

​	同样的方式，智能合约S6安装在对等节点P3，定义在通道C2上，用来为账本L2提供可控的访问。应用程序A3现在能够使用通道C2来调用智能合约S6提供的服务来产生交易，这些交易会在网络中被每个账本的副本所接受。

​	到目前为止，我们有一个独立的网络，其中定义了两个完全独立的通道。这些通道为组织提供了独立的管理设施来与彼此交易。这就是去中心化，我们在管控和自制之间达到了一个平衡。这是通过通道策略来实现的，这些通道由不同的组织控制，而通道又会影响这些组织。

## 把一个对等节点添加到多个通道中

​	在网络开发的最后一个阶段，让我们把焦点再转回组织 R2。我们可以通过把 R2 加入到多个通道中的方式来让它同时成为两个联盟 X1 和 X2 的成员。

​										![network.multichannel](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.12.png)

​	这个图展示了在网络N中关于通道C1和C2的以下内容：客户端应用程序A1能够使用通道C1与节点P1和P2以及排序服务O4进行通信。客户端应用程序A2可以使用通道C1与节点P1和P2进行通信，以及使用通道C2与节点P2和P3以及排序服务O4进行通信。客户端应用程序A3能够使用通道C2与节点P3和P2和排序服务O4进行通信。排序服务O4能够使用通道C1和C2的通信服务。通道配置CC1应用在了通道C1中，CC2应用在了通道C2中

​	我们能够看到，R2在网络中是一个特别的组织，因为它是唯一一个同时属于两个通道成员的组织！它能够在通道C1上跟组织R1进行交易，也能够同时使用另外一个通道C2来跟组织R3进行交易。

​	注意，节点P2将智能合约S5安装在通道C1中，将智能合约S6安装在通道C2中。节点P2同时是两个通道的成员，并且通过不同的智能合约来处理不同的账本。

​	通道是一个非常强大的概念，既实现了组织间的隔离，又提供了组织间进行合作的机制。总的来说，这个基础设施是由一系列独立的组织来组成的，并且在这些组织间进行共享。

​	重点需要注意的是，在不同通道上交易时对等节点P2的行为受到不同的约束。在通道配置CC1中包含的策略决定了P2在通道C1中进行交易的时候的操作，在通道配置CC2中包含的策略决定了P2在通道C2中进行交易的时候的操作.

​	R2和R1对通道C1的规则达成一致，R2和R3对通道C2的规则达成一致。这些规则包含在对应的通道策略中，它们必须要在通道中被强制执行正确的操作，就像当初达成的共识那样。

​	类似的，我们能够看到客户端应用程序A2现在能够在通道C1和C2上进行交易。同样，它也会按照在相关通道配置中的策略来进行管理。另外，注意用于表示客户端应用程序A2和对等节点P2的图标，既包括线也包括连接点，它们是等价的。

### 排序服务

​	善于观察的读者可能已经注意到排序服务看起来像是一个中心化的组件，它最初被用来创建这个网络，然后连接到了网络中的每个通道。即使我们添加 R1 和 R4 到了管理排序服务的网络配置策略 NC4，这个排序节点依旧是运行在 R4 的基础设施上。在一个去中心化的世界中，这个看起来是错误的！

​	不必担心！为了帮助你从网络管理员的角度来理解，我们的示例网络显示的是一个最简单的排序服务配置。事实上，排序服务本身可以是完全去中心化的！我们之前提到过一个排序服务可以包含很多单独的由不同组织所拥有的节点，让我们看一下在我们的网络中应该怎么做。

​	让我们看一个更加真实的排序服务节点配置：							![network.finalnetwork2](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.15.png)

​	图中是一个多组织的排序服务。排序服务包括排序节点O1和O4。O1是由组织R1提供的，O4是由组织R4提供的。网络配置NC4中定义了来自R1和R4的操作者的网络资源权限。

​	我们能够看到这个排序服务是完全去中心化的，它在组织R1和R4中运行。网络配置策略NC4赋予了R1和R4对于网络资源相同的权限。R1和R4的客户端应用程序和对等节点可以通过连接O1或者O4来管理网络资源，就像在网络配置NC4中定义的策略一样，两个节点是用相同的方式来操作的。在实际中，一个组织中的操作者更愿意使用自己组织提供的基础设施，但是也并不总是这样的。

### 去中心化的交易分发

​	除了作为网络的管理节点，排序服务同样提供了另外一个关键的设施——交易的分发节点。排序服务这个组件会从应用程序搜集已被背书的交易，然后它会把这些交易进行排序并放进区块中，这些区块会被分发到通道中的每个对等节点。在每个提交节点中，交易不管是有效的还是无效的都会被记录下来，并且他们本地账本副本也会更新。

​	注意这里，排序节点O4在通道C1扮演着和网络N不同的角色。当在通道级别操作时，O4的角色是搜集交易并在通道中分发区块。它依据通道配置CC1中定义的策略来操作。当在网络级别操作时，O4的角色是提供对网络资源的管理，这是根据网络配置NC4中定义的策略来操作的。我们应该注意这些不同的角色是如何在通道和网络的配置中定义的。这个会加强你对 Hyperledger Fabric 中基于配置的可声明策略的重要性的印象。网络中会同时定义这两种策略并用来管控联盟中的每个成员只能进行商定好的行为。

​	我们能够看到排序服务和 Hyperledger Fabric 中的其他组件一样，是一个完全去中心化的组件。不管是作为一个网络的管理节点，还是作为一个通道中的区块分发节点，排序节点可以根据需求分布运行在网络中的多个组织中。

### 修改策略

​	经过我们对于这个示例网络的解析，我们看到了对系统中的角色使用策略的重要性。我们仅仅讨论了一部分可用策略，但我们还可以声明定义很多用于控制不同方面的行为的策略。这些单独的策略会在文档的其他部分讨论。

​	最重要的一点，Hyperledger Fabric 提供了一个独特且强大的策略来允许网络和通道管理员自己来管理策略的变更！基本的观念是，策略的变更是经常发生的，无论它是发生在不同的组织间，还是由外部的监管者施加的。比如一个新的组织想要加入一个通道或者一些已经存在的组织的权限可能被提高或者降低。让我们来详细的看一下在Hyperledger Fabric中修改策略是如何实现的。

​	理解这个的关键是，策略变更是由策略本身中的策略管理的。那就是修改策略，或者简称mod_policy，它是在管理变化的网络或者通道配置中的头等策略。关于我们是如何使用mod_policy来管理网络中的变化，我们提供了两个简单的示例。

​	第一个例子是创建网络初始的时候。这时，只有组织R4被允许管理网络。在实际当中，这个是通过在网络配置NC4中把R4定义为唯一一个有权限来管理网络资源的组织来实现的。并且NC4的mod_policy中只有R4，所以只有R4能对NC4的配置进行修改

​	我们接下来将网络N进行了演进，同时允许组织R1来管理网络。R4通过将R1添加到通道创建和联盟创建的策略中来实现。因为这个改动，R1就可以定义联盟X1和X2了，并且可以创建通道C1和C2。R1在网络配置中对于通道和联盟策略具备了同样的管理权限。

​	R4甚至可以通过网络配置来给R1赋予更大的权限！R4可以将R1添加到mod_policy，这样R1就同样可以管理这个网络中的变更了。

​	第二个权利要比第一个权利大的多，因为现在R1具有了在网络配置NC4上的所有权限！这意味着，R1能够移除R4在这个网络的管理权限。在实际当中，R4会将mod_policy配置成对这样的改动需要R4批准，或者需要所有在mod_policy中定义的组织批准。在这里可以灵活地配置mod_policy来满足需求。

​	这就是mod_policy的作用。它允许一个基本的配置被修改为一个成熟的配置。mod_policy像在一个网络或者通道配置中其他的策略一样，它定义了一个组织集合，这些组织被允许对这个mod_policy进行修改。

​	我们仅仅在这个部分了解了策略以及mod_policy的表面的内容。我们会在策略的话题中有更详细的讨论，但是现在让我们回到这个已经完成的网络！

### 完全体网络

​	让我们使用一个统一的表示图来回顾一下我们的网络应该是什么样。我们使用更加紧凑的方式来稍微重新组织一下这个网络，因为它能够更好地适应规模更大拓扑结构：

![network.finalnetwork2](https://hyperledger-fabric.readthedocs.io/en/latest/_images/network.diagram.14.png)

​	在这个图中，我们看到了这个Fabric区块链网络包括了两个应用程序通道以及一个排序通道。组织R1和R4负责排序通道，R1和R2负责蓝色的应用程序通道，R2和R3负责红色的应用程序通道。客户端应用程序A1是组织R1的元素，CA1是它的证书颁发机构。注意到组织R2的节点P2可以使用蓝色的通信设施，也可以使用红色的应用程序通道。每个应用程序通道具有它自己的通道配置，这里是CC1和CC2。系统通道的通道配置是网络配置NC4的一部分。

​	我们已经在概念上构建了一个 Hyperledger Fabric 区块链网络实例的最后一部分了。我们创建了一个有四个组织的网络，带有两个通道和三个对等节点，两个智能合约和一个排序节点。并由四个证书颁发机构来支撑。它为三个客户端应用程序提供了账本及智能合约服务，这些应用程序可以通过两个通道与账本和智能合约进行交互。花些时间来仔细看看这个图中网络的详细内容，并且随时回来阅读这个部分来加强你的理解，或者查看其它更详细的话题。

### 网络组件的总结

​	下边是我们讨论过的网络组件的一个快速总结：

- 账本。每个通道一个，由区块链和世界状态组成
- 智能合约（链码）
- 对等节点
- 排序服务
- 通道
- 证书颁发机构

## 网络总结

​	在本主题中，我们了解了不同的组织是如何共享它们的基础设施从而组成一个完整的 Hyperledger Fabric 区块链网络。我们了解了如何将集体基础设施组成为提供独立管理的私有通信机制的通道。我们也看到了如何使用来自各自证书颁发机构的证书来识别来自不同组织的参与者，比如客户端应用程序、管理员、节点和排序节点。另外，我们也看到了策略的重要性，它定义了这些组织参与者在网络和通道资源上拥有的经过一致同意的权限。

